<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>AVCON运维系统-维护主页</title>
    <link rel="stylesheet" href="../js/layui/css/layui.css">
</head>

<body class="">
    <div class="layui-layout layui-layout-admin" id="app">
        <div class="layui-header">
            <div class="layui-logo">AVCON运维系统</div>
            <!-- 头部区域（可配合layui已有的水平导航） -->
            <ul class="layui-nav layui-layout-left">
                <!-- <li class="layui-nav-item layui-this"> -->
                <li @click="changePage(0)" :class="pageIndex==0?'layui-nav-item layui-this':'layui-nav-item'">
                    <a href="javascript:void(0)">待办工单
                        <span class="layui-badge" v-if="todoOrderlist.length>0">{{todoOrderlist.length}}</span>
                    </a>
                </li>
                <li @click="changePage(1)" :class="pageIndex==1?'layui-nav-item layui-this':'layui-nav-item'">
                    <a href="javascript:void(0)">已办工单
                        <!-- <span class="layui-badge-dot"></span> -->
                    </a>
                </li>
                <li @click="changePage(2)" :class="pageIndex==2?'layui-nav-item layui-this':'layui-nav-item'">
                    <a href="javascript:void(0)">办结工单</a>
                </li>
            </ul>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item">
                    <a href="javascript:;">
                        <img src="http://t.cn/RCzsdCq" class="layui-nav-img"> {{username}}
                    </a>
                    <dl class="layui-nav-child">
                        <dd>
                            <a href="">基本资料</a>
                        </dd>
                        <dd>
                            <a href="">修改密码</a>
                        </dd>
                        <dd>
                            <a href="login.html">退出</a>
                        </dd>
                    </dl>
                </li>
            </ul>
        </div>
        <div class="layui-body layui-bg-black" style="left: 0;">
            <!-- 内容主体区域 -->
            <div id='waitdispatchorder' style="padding: 15px;">
                <div style="text-align:right;">
                    <button class="layui-icon layui-icon-refresh" style="font-size: 20px; width:50px" onclick="refreshTodoOrderList()"></button>
                </div>
                <table class="layui-table">
                    <tr>
                        <td>单号</td>
                        <td>报修人员</td>
                        <td>生成时间</td>
                        <td>限定时间</td>
                        <td>当前进度</td>
                        <td>是否延期</td>
                    </tr>
                    <tr v-for="(order,i) in todoOrderlist" @click="todoedit(order,'todolist')">
                        <td>{{order.orderid}}</td>
                        <td>{{order.alloctorname}}</td>
                        <td>{{order.time|timestamp}}</td>
                        <td>{{order.term|timestamp}}</td>
                        <td>{{getStatus(order.status)}}</td>
                        <td>
                            <a class="layui-btn layui-btn-xs" lay-event="del" v-bind:class="{'layui-btn-danger ':judgeOverTerm(order.term)=='是'}">{{judgeOverTerm(order.term)}}</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div id='alreadydispatchorder' style="padding: 15px; display: none">
                <div style="text-align:right;">
                    <button class="layui-icon layui-icon-refresh" style="font-size: 20px; width:50px" onclick="refreshDealtOrderlist()"></button>
                </div>
                <table class="layui-table">
                    <tr>
                        <td>单号</td>
                        <td>报修人员</td>
                        <td>生成时间</td>
                        <td>限定时间</td>
                        <td>当前进度</td>
                        <td>是否延期</td>
                    </tr>
                    <tr v-for="(order,i) in dealtOrderlist" @click="todoedit(order,'')">
                        <td>{{order.orderid}}</td>
                        <td>{{order.alloctorname}}</td>
                        <td>{{order.time|timestamp}}</td>
                        <td>{{order.term|timestamp}}</td>
                        <td>{{getStatus(order.status)}}</td>
                        <td>
                            <a class="layui-btn layui-btn-xs" lay-event="del" v-bind:class="{'layui-btn-danger ':judgeOverTerm(order.term)=='是'}">{{judgeOverTerm(order.term)}}</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div id='closeorder' style="padding: 15px; display: none">
                <div style="text-align:right;">
                    <button class="layui-icon layui-icon-refresh" style="font-size: 20px; width:50px" onclick="refreshCloseOrderlist()"></button>
                </div>
                <table class="layui-table">
                    <tr>
                        <td>单号</td>
                        <td>报修人员</td>
                        <td>生成时间</td>
                        <td>限定时间</td>
                        <td>当前进度</td>
                        <td>是否延期</td>
                    </tr>
                    <tr v-for="(order,i) in closeOrderlist" @click="todoedit(order,'')">
                        <td>{{order.orderid}}</td>
                        <td>{{order.alloctorname}}</td>
                        <td>{{order.time|timestamp}}</td>
                        <td>{{order.term|timestamp}}</td>
                        <td>{{getStatus(order.status)}}</td>
                        <td>
                            <a class="layui-btn layui-btn-xs" lay-event="del" v-bind:class="{'layui-btn-danger ':judgeOverTerm(order.term)=='是'}">{{judgeOverTerm(order.term)}}</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="layui-footer" style="left: 0; text-align: center">
            版权所有 © www.avcon.com.cn - 华平智慧信息技术（深圳）有限公司
        </div>
    </div>

    <script src="../js/base64.js"></script>
    <script src="../js/layui/layui.js"></script>
    <script src="../js/vue.js"></script>
    <script src="../js/const-defined.js"></script>
    <script src="../js/webservice-re.js"></script>
    <script>
        function add0(_m) { return _m < 10 ? '0' + _m : _m; }
        function format(_timestamp, _formate) {
            var time = new Date(_timestamp);            //_timestamp要int型
            var y = time.getFullYear();
            var m = time.getMonth() + 1;
            var d = time.getDate();
            var h = time.getHours();
            var mm = time.getMinutes();
            var s = time.getSeconds();
            if (_formate == 'date') {
                return y + '-' + add0(m) + '-' + add0(d);
            } else if (_formate == 'time') {
                return add0(h) + ':' + add0(mm) + ':' + add0(s);
            } else {
                console.log(y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s));
                return y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s);
            }
        }


        function refreshTodoOrderList() {
            WebService.getOrderList(localStorage.maintenanceToken, "", "", ["0", "2"], function (_retcode, _data) {
                if (!_retcode) {
                    self.location = "login.html"
                    return;
                }

                vm.$set(vm, "todoOrderlist", []);
                if (!_data.list) {
                    return;
                }

                for (i = 0; i < _data.list.length; i++) {
                    vm.$set(vm.todoOrderlist, i, _data.list[i]);
                }
                console.log(_data);
            })
        }

        function refreshCloseOrderlist() {
            WebService.getOrderList(localStorage.maintenanceToken, "", "", ["4"], function (_retcode, _data) {
                if (!_retcode) {
                    self.location = "login.html"
                    return;
                }

                vm.$set(vm, "closeOrderlist", []);
                if (!_data.list) {
                    return;
                }

                for (i = 0; i < _data.list.length; i++) {
                    vm.$set(vm.closeOrderlist, i, _data.list[i]);
                }
                console.log(_data);
            })
        }

        function refreshDealtOrderlist() {
            WebService.getOrderList(localStorage.maintenanceToken, "", "", ["1", "3"], function (_retcode, _data) {
                if (!_retcode) {
                    self.location = "login.html"
                    return;
                }

                vm.$set(vm, "dealtOrderlist", []);
                if (!_data.list) {
                    return;
                }

                for (i = 0; i < _data.list.length; i++) {
                    vm.$set(vm.dealtOrderlist, i, _data.list[i]);
                }
            })
        }

        function init() {
            Vue.filter("timestamp", function (_timestamp) {
                return format(_timestamp * 1000);
            })
            vm = new Vue({
                el: "#app",
                data: {
                    pageIndex: 0,
                    todoOrderlist: [],
                    dealtOrderlist: [],
                    closeOrderlist: [],
                    username: localStorage.maintenanceUser
                },
                methods: {
                    getStatus(_status) {
                        var status = "未知"
                        switch (_status) {
                            case "0":
                            case "1":
                                status = "待确认";
                                break;
                            case "2":
                                status = "维修中";
                                break;
                            case "3":
                                status = "已维修";
                                break;
                            case "4":
                                status = "已关闭";
                        }
                        return status;
                    },
                    judgeOverTerm(_term) {
                        var timestamp = Date.parse(new Date());
                        console.log(_term, "-----", parseInt(timestamp, 10));
                        return (parseInt(timestamp) / 1000) > _term ? "是" : "否";
                    },
                    changePage(_num) {
                        this.pageIndex = _num;
                        //没想到用vue了还要直接操作DOM
                        document.getElementById('waitdispatchorder').style.display = (_num == 0 ? "block" : "none");
                        document.getElementById('alreadydispatchorder').style.display = (_num == 1 ? "block" : "none");
                        document.getElementById('closeorder').style.display = (_num == 2 ? "block" : "none");
                        refreshTodoOrderList();
                        refreshDealtOrderlist();
                        refreshCloseOrderlist();
                    },
                    todoedit(_order, _type) {
                        layer.open({
                            type: 2
                            , title: false //不显示标题栏
                            , closeBtn: true
                            , area: ['800px', '480px']
                            , shade: 0.8
                            , id: 'ORDER_INFO' //设定一个id，防止重复弹出
                            //, btn: ['确认维修', '拒绝维修']
                            , btnAlign: 'c'
                            , moveType: 1 //拖拽模式，0或者1
                            , content: "./repairer-orderinfo.html?orderinfo=" + base.encode(JSON.stringify(_order))
                            // , success: function (layero) {
                            //     var btn = layero.find('.layui-layer-btn');
                            //     btn.find('.layui-layer-btn0').attr({
                            //     });
                            , end: function () {
                                if (_type == "todolist") {
                                    refreshTodoOrderList();
                                }
                                console.log("end............");
                            }
                        });
                    }
                }
            });

            refreshTodoOrderList();
            //refreshDealtOrderlist();
        }

        init();

        //JavaScript代码区域
        layui.use(['element', 'layer'], function () {
            var element = layui.element;

        });
    </script>
</body>

</html>